@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model List<SEYRİ_ALA.Models.City>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

@functions {
    string GetRegion(string cityName)
    {
        string[] marmara = { "İstanbul", "Edirne", "Çanakkale", "Bursa", "Kocaeli", "Sakarya", "Tekirdağ", "Balıkesir", "Yalova", "Kırklareli", "Bilecik" };
        string[] ege = { "İzmir", "Aydın", "Muğla", "Manisa", "Denizli", "Afyonkarahisar", "Kütahya", "Uşak" };
        string[] akdeniz = { "Antalya", "Adana", "Mersin", "Hatay", "Isparta", "Burdur", "Osmaniye", "Kahramanmaraş" };
        string[] icAnadolu = { "Ankara", "Konya", "Kayseri", "Eskişehir", "Sivas", "Kırıkkale", "Aksaray", "Karaman", "Kırşehir", "Niğde", "Nevşehir", "Yozgat", "Çankırı" };
        string[] karadeniz = { "Trabzon", "Samsun", "Ordu", "Rize", "Giresun", "Artvin", "Sinop", "Kastamonu", "Bolu", "Düzce", "Zonguldak", "Tokat", "Gümüşhane", "Bayburt", "Bartın", "Karabük", "Amasya", "Çorum" };
        string[] doguAnadolu = { "Erzurum", "Malatya", "Elazığ", "Van", "Erzincan", "Kars", "Hakkari", "Muş", "Bitlis", "Ağrı", "Iğdır", "Ardahan", "Tunceli", "Bingöl" };
        string[] guneyDogu = { "Gaziantep", "Şanlıurfa", "Diyarbakır", "Mardin", "Adıyaman", "Batman", "Siirt", "Şırnak", "Kilis" };

        if (marmara.Contains(cityName)) return "Marmara";
        if (ege.Contains(cityName)) return "Ege";
        if (akdeniz.Contains(cityName)) return "Akdeniz";
        if (icAnadolu.Contains(cityName)) return "İç Anadolu";
        if (karadeniz.Contains(cityName)) return "Karadeniz";
        if (doguAnadolu.Contains(cityName)) return "Doğu Anadolu";
        if (guneyDogu.Contains(cityName)) return "Güneydoğu";
        return "Tümü";
    }
}

@* 1. HERO SECTION *@
<div class="hero-section text-center">
    <div class="hero-content">
        <h1 class="display-2 fw-bold mb-3 text-white">Seyri Âlâ</h1>
        <p class="lead mb-4 text-white-50">Türkiye'nin kadim şehirlerinde sana özel bir yolculuk.</p>
        <a href="#selection-start" class="btn btn-primary btn-lg px-5 rounded-pill shadow-lg explore-btn">✨ Keşfetmeye Başla</a>
    </div>
</div>

<div class="container-fluid px-lg-5" id="selection-start">
    @* 2. BÖLGE SEÇİM ALANI *@
    <div class="text-center py-5">
        <h2 class="fw-bold mb-4">Önce Bir Bölge Seçin</h2>
        <div class="d-flex gap-2 justify-content-center flex-wrap region-nav">
            @{
                string[] regions = { "Marmara", "Ege", "Akdeniz", "İç Anadolu", "Karadeniz", "Doğu Anadolu", "Güneydoğu" };
            }
            @foreach (var region in regions)
            {
                <button class="region-pill" onclick="selectRegion('@region', this)">@region</button>
            }
        </div>
    </div>

    @* 3. YANA KAYDIRILABİLİR ŞEHİRLER *@
    <div id="city-scroller-container" style="display:none;" class="mb-5">
        <div class="d-flex overflow-auto pb-4 gap-4 custom-scrollbar" id="city-scroller">
            @foreach (var city in Model)
            {
                <div class="city-card-item" data-region="@GetRegion(city.Name)">
                    <div class="card city-card border-0 shadow-lg h-100"
                         onclick="focusMap(@city.Latitude.ToString().Replace(',', '.'), @city.Longitude.ToString().Replace(',', '.'), '@city.Name', @city.Id)">
                        <img src="https://loremflickr.com/400/250/@city.Name,city/all" class="card-img-top" style="height: 160px; object-fit: cover; border-radius: 20px;">
                        <div class="card-body p-3 text-center">
                            <h6 class="fw-bold mb-0">@city.Name</h6>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    @* 4. HARİTA (SABİT) *@
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div id="map-frame" class="shadow-lg">
                <div id="map" style="height: 500px; width: 100%; border-radius: 30px; z-index: 1;"></div>
            </div>
        </div>
    </div>

    @* 5. AI KRİTER BALONCUĞU *@
    <div class="row justify-content-center pb-5">
        <div class="col-lg-8">
            <div class="ai-box p-5 shadow-lg">
                <h3 class="text-center fw-bold mb-4">Gezmek istediğiniz yerin kriterleri nelerdir?</h3>
                <div class="d-flex flex-wrap gap-3 justify-content-center mb-4">
                    <div class="filter-check"><input type="checkbox" id="c1"><label for="c1">📜 Tarihi Doku</label></div>
                    <div class="filter-check"><input type="checkbox" id="c2"><label for="c2">🌲 Doğal Yapı</label></div>
                    <div class="filter-check"><input type="checkbox" id="c3"><label for="c3">🍲 Gastronomi</label></div>
                    <div class="filter-check"><input type="checkbox" id="c4"><label for="c4">🎨 Sanat & Kültür</label></div>
                </div>
                <textarea id="ai-text" class="form-control mb-4" rows="3" placeholder="Yapay zekaya detayları yazın..."></textarea>
                <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold" onclick="generateAi()">🚀 Rota Oluştur</button>

                <div id="ai-loading" class="text-center mt-3" style="display:none;">
                    <div class="spinner-grow text-primary" role="status"></div>
                    <p class="mt-2 text-info pulse">Yapay Zekamız Sizin İçin En Uygun Rotaları Analiz Ediyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .hero-section {
        background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1920&q=80');
        background-size: cover;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0 0 100px 100px;
        margin-bottom: 20px;
    }

    .region-pill {
        padding: 10px 25px;
        border-radius: 50px;
        border: 2px solid #0d6efd;
        background: transparent;
        color: #0d6efd;
        font-weight: bold;
        transition: 0.3s;
    }

        .region-pill.active {
            background: #0d6efd;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(13,110,253,0.3);
        }

    .city-card-item {
        min-width: 240px;
    }

    .city-card {
        border-radius: 20px;
        transition: 0.4s;
        cursor: pointer;
        background: var(--bs-body-bg);
    }

        .city-card:hover {
            transform: translateY(-10px);
        }

    #map-frame {
        border: 8px solid white;
        border-radius: 38px;
        overflow: hidden;
    }

    .ai-box {
        background: rgba(255,255,255,0.05);
        backdrop-filter: blur(10px);
        border-radius: 40px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .filter-check input {
        display: none;
    }

    .filter-check label {
        padding: 10px 20px;
        background: rgba(0,0,0,0.2);
        border-radius: 15px;
        cursor: pointer;
        transition: 0.3s;
    }

    .filter-check input:checked + label {
        background: #0d6efd;
        color: white;
    }

    .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #0d6efd;
        border-radius: 10px;
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }
    }
</style>

<script>
    var map;

    // 1. Sayfa yüklendiğinde haritayı hazırla
    document.addEventListener("DOMContentLoaded", function () {
        map = L.map('map').setView([39.9334, 32.8597], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Harita kutusu render sorunlarını çözer
        setTimeout(function(){ map.invalidateSize(); }, 500);
    });

    // 2. Bölge Seçildiğinde Resimleri Getiren Fonksiyon (UNUTULAN KISIM)
    function selectRegion(region, btn) {
        // Butonların aktiflik stilini değiştir
        document.querySelectorAll('.region-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Şehir kaydırma alanını görünür yap
        const scrollerContainer = document.getElementById('city-scroller-container');
        scrollerContainer.style.display = 'block';

        // Sadece seçilen bölgenin kartlarını göster
        const cards = document.querySelectorAll('.city-card-item');
        cards.forEach(card => {
            if (card.getAttribute('data-region') === region) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        // Sayfayı hafifçe resimlerin olduğu yere kaydır
        scrollerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 3. Şehre Tıklayınca Haritaya Uçan Fonksiyon
    function focusMap(lat, lng, name, id) {
        if (map) {
            // Haritayı ilgili konuma taşı
            map.flyTo([lat, lng], 11, { animate: true, duration: 1.5 });

            // İşaretçiyi ekle ve butonu göster
            L.marker([lat, lng]).addTo(map)
                .bindPopup(`
                    <div class="text-center">
                        <b style="font-size:16px;">${name}</b><br>
                        <button class="btn btn-primary btn-sm mt-2"
                                onclick="window.location.href='/Home/Details/${id}'">
                            📍 Detaylara Git
                        </button>
                    </div>
                `).openPopup();
        }
    }

    // 4. AI Rota Oluşturma İllüzyonu
    function generateAi() {
        const loading = document.getElementById('ai-loading');
        loading.style.display = 'block';
        setTimeout(() => {
            alert("Harika! Kriterlerinize uygun rotalar hesaplandı.");
            loading.style.display = 'none';
        }, 3000);
    }
</script>